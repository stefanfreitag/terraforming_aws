<!-- markdownlint-disable MD012 -->

# Terraforming AWS



## Terraform

- Helps to of codify infrastructure
- Is offered by [HashiCorp](https://www.hashicorp.com/)
- Other HashiCorp products
  - [Consul](https://www.consul.io/)
  - [Vault](https://www.vaultproject.io/)




## Key features


### Infrastructure as Code

- Infrastructure is described using a high-level configuration syntax
- Configuration can be versioned, shared and re-used


### Execution Plans

- Separation of planning and execution phase
- Commands `plan` and `apply`
- "Planning" phase: generation of an execution plan
- Execution plan shows what Terraform will do when you call `apply`
- Avoids surprises when Terraform manipulates infrastructure


### Resource Graph

Terraform builds a graph of all your resources
- parallelizes the creation and modification of any non-dependent resources.
- allow operators to  get insight into dependencies in their infrastructure.



## Terraform Editions

- Open Source
- Cloud
- Self-Hosted

TODO: Add information about differences



## Terraform Speak


### Configuration

- Code written in Terraform's configuration language
- Declarative description the desired infrastructure state
- A config consists of a root module, which can optionally call any number of child modules


```plain
+ resource "aws_lambda_function" "cdktfawsapigwlambdahelloWorld_helloworldgw_lambdahelloworld_F75E1DA8" {
      + arn                   = (known after apply)
      + description           = "A simple Hello world Lambda Function"
      + filename              = "../hello_world.zip"
      + function_name         = "helloWorld"
      + handler               = "hello_world.lambda_handler"
      + invoke_arn            = (known after apply)
      + memory_size           = 128
      + publish               = false
      + qualified_arn         = (known after apply)
      + role                  = (known after apply)
      + runtime               = "python3.7"
      + timeout               = 60
      + version               = (known after apply)
      ...
```


### Module

- Self-contained collection of Terraform configurations that manages a collection of related infrastructure resources.
- Other Terraform configurations can call a module, which tells Terraform to manage any resources described by that module.
- Modules define input variables (which the calling module can set values for) and output values (which the calling module can reference in expressions).

TODO: Add example for module

TODO: Add resource example (as we reference to it on the next slide)

### Provider

- Makes a collection of related resources available
- Is responsible for understanding API interactions with some kind of service and exposing resources based on that API
- Providers are generally tied to a specific infrastructure provider
  - Infrastructure as a service (IaaS) provider (like AWS, GCP, Microsoft Azure, OpenStack)
  - Platform as a service (PaaS) provider (like Heroku)
  - Software as a service (SaaS) provider (like Terraform Cloud, DNSimple, Cloudflare)


## How it works

### Installation

- Download a zip archive
- Extract the archive
- Make the contained binary executable
- Move it to the proper directory


```sh  
wget https://releases.hashicorp.com/terraform/0.13.4/terraform_0.13.4_linux_amd64.zip
unzip terraform_0.13.4_linux_amd64.zip
chmod a+x terraform
sudo mv terraform /usr/local/bin/terraform
```


# CLI commands

| Name | Description |
| --- | --- |
| <small>apply</small> | <small>Builds or changes infrastructure</small> |
| <small>destroy</small> | <small>Destroy Terraform-managed infrastructure</small>
| <small>fmt</small> | <small>Rewrites config files to canonical format</small>
| <small>get</small> | <small>Download and install modules for the configuration</small>
| <small>graph</small> | <small>Create a visual graph of Terraform resources</small>
| <small>import</small> | <small>Import existing infrastructure into Terraform</small>
| <small>init</small> | <small>Initialize a Terraform working directory</small>
| <small>plan</small> | <small>Generate and show an execution plan</small>
| <small>show</small> | <small>Inspect Terraform state or plan</small>



### Basic commands

- apply<br>The terraform apply command is used to apply the changes required to reach the desired state of the configuration, or the pre-determined set of actions generated by a terraform plan execution plan.
- graph<br>
The terraform graph command is used to generate a visual representation of either a configuration or execution plan. The output is in the DOT format, which can be used by GraphViz to generate charts.
- plan<br>The terraform plan command is used to create an execution plan. Terraform performs a refresh, unless explicitly disabled, and then determines what actions are necessary to achieve the desired state specified in the configuration files.

This command is a convenient way to check whether the execution plan for a set of changes matches your expectations without making any changes to real resources or to the state. For example, terraform plan might be run before committing a change to version control, to create confidence that it will behave as expected.

The optional -out argument can be used to save the generated plan to a file for later execution with terraform apply, which can be useful when running Terraform in automation.

If Terraform detects no changes to resource or to root module output values, terraform plan will indicate that no changes are required.


## Stages when running Terraform

- Pending: Terraform Cloud hasn't started action on a run yet. Terraform Cloud processes each workspace's runs in the order they were queued, and a run remains pending until every run before it has completed.
- Plan:
(- Cost Estimation)
This stage only occurs if cost estimation is enabled. After a successful terraform plan, Terraform Cloud uses plan data to estimate costs for each resource found in the plan.
- Policy Check: This stage only occurs if Sentinel policies are enabled. After a successful terraform plan, Terraform Cloud checks whether the plan obeys policy to determine whether it can be applied.

- Apply: After applying,  the run proceeds automatically to completion.


# Terraform CDK

- helps users define infrastructure resources using supported programming languages and generates a Terraform configuration in JSON
- users can then use the Terraform or the CDK for Terraform CLI to deploy the application
- uses AWS CDK constructs to define applications

(from Github project page)


The CDK for Terraform project includes two packages:

- `cdktf-cli` - A CLI that allows users to run commands to initialize, import, and synthesize CDK for Terraform applications
- `cdktf` - A library for defining Terraform resources using programming constructs

The project currently supports TypeScript, Python, and Java

(from Github project page)


## Example budget notifier

## Links

- [Awesome Terraform](https://github.com/shuaibiyy/awesome-terraform)
- [HCL](https://github.com/hashicorp/hcl)
- [Learn Terraform](https://learn.hashicorp.com/terraform)
- [Terraform CDK](https://github.com/hashicorp/terraform-cdk)



